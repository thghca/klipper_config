[gcode_macro END_PRINT]
gcode:
	TRY_END_RETRACT
	PRESENT_PRINT
                           
	M106 S0 ;Turn-off fan
	M104 S0 ;Turn-off hotend
	M140 S0 ;Turn-off bed

	M220 S100 ; reset feedrate
	M221 S100 ; reset flow
	M900 K0; LA off

	M84 X Y E ;Disable all steppers but Z
	
	M117 Finished  
	M400; wait for finish 
	
                               
[gcode_macro TRY_END_RETRACT]
gcode:
	SAVE_GCODE_STATE NAME=try_end_retract_state

	{% if printer.extruder.can_extrude %}
		M117	Retracting...
		G91	;Relative mode                                         
		G1 E-0.5 F3000                                    
		G1 E-1 Z0.2 F2400                                                          
	{% endif %}

	RESTORE_GCODE_STATE NAME=try_end_retract_state
	