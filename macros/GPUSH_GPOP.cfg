[gcode_macro _GPUSH]
variable_head: 0
gcode:		
	{% set next = printer["gcode_macro _GPUSH"].head|int + 1 %}
	SAVE_GCODE_STATE NAME={"STACK" ~ next}
	SET_GCODE_VARIABLE MACRO=_GPUSH VARIABLE=head VALUE={next}

[gcode_macro _GPOP]
gcode:
	{% set head  = printer["gcode_macro _GPUSH"].head|int %}
	RESTORE_GCODE_STATE NAME={"STACK" ~ head ~ " " ~ rawparams }
	SET_GCODE_VARIABLE MACRO=_GPUSH VARIABLE=head VALUE={head - 1}